datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  password      String?
  image         String?
  phoneNumber   String?
  address       String?
  city          String?
  state         String?
  postalCode    String?
  country       String?
  role          Role      @default(USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime? // Soft delete

  sites         Site[]
  payments      Payment[]
  subscriptions Subscription[]
}

enum Role {
  USER
  ADMIN
}

model Site {
  id            String    @id @default(cuid())
  domain        String    @unique // Primary domain (e.g., example.com)
  serverPath    String?   // Path on VPS (e.g., /var/www/example.com)
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  status        SiteStatus @default(ACTIVE)
  sslStatus     SslStatus  @default(NONE)
  subscriptionId String?   @unique
  subscription  Subscription? @relation(fields: [subscriptionId], references: [id])
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime? // Soft delete
  serverIp      String?   // Assigned by Admin
  envVars       String?   @db.Text
  dbConnection  String?

  deployments   Deployment[]
}

enum SslStatus {
  NONE
  PENDING
  ACTIVE
  FAILED
}

enum SiteStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

model Deployment {
  id            String    @id @default(cuid())
  siteId        String
  site          Site      @relation(fields: [siteId], references: [id])
  status        DeployStatus @default(PENDING)
  type          DeploymentType @default(ZIP)
  uploadPath    String?   // Path to the extracted files
  archivePath   String?   // Path to the original zip file
  gitRepoUrl    String?
  gitBranch     String?
  logs          DeploymentLog[]
  createdAt     DateTime  @default(now())
  // No soft delete needed for logs usually, but BRD said "All tables"
  // Let's add it to be safe, or assume logs are immutable history.
  // BRD: "All tables must include... Soft delete support"
  deletedAt     DateTime?
}

model DeploymentLog {
  id            String    @id @default(cuid())
  deploymentId  String
  deployment    Deployment @relation(fields: [deploymentId], references: [id])
  step          String
  output        String    @db.Text
  status        String    // SUCCESS, FAILED, PENDING
  timestamp     DateTime  @default(now())
  deletedAt     DateTime?
}

enum DeployStatus {
  PENDING
  BUILDING
  DEPLOYED
  FAILED
}

enum DeploymentType {
  ZIP
  GIT
}

model Plan {
  id          String   @id @default(cuid())
  name        String
  price       Float
  price2Years Float?   // Optional price for 2 years
  price3Years Float?   // Optional price for 3 years
  duration    Int      // Duration in days
  description String?
  features    String[]
  isActive    Boolean  @default(true)
  requiresEnv Boolean  @default(false)
  providesDb  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt     DateTime?
  
  payments    Payment[]
  subscriptions Subscription[]
}

model Subscription {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  planId        String
  plan          Plan      @relation(fields: [planId], references: [id])
  startDate     DateTime
  endDate       DateTime
  status        SubscriptionStatus @default(ACTIVE)
  site          Site?
  payments      Payment[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

model Payment {
  id                String    @id @default(cuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id])
  planId            String?
  plan              Plan?     @relation(fields: [planId], references: [id])
  subscriptionId    String?
  subscription      Subscription? @relation(fields: [subscriptionId], references: [id])
  amount            Float
  currency          String    @default("INR")
  status            PaymentStatus @default(PENDING)
  razorpayOrderId   String?   @unique
  razorpayPaymentId String?   @unique
  razorpaySignature String?
  invoiceNumber     String?   @unique
  gstNumber         String?   // Optional GST number for invoice
  gstAmount         Float?    // Optional GST amount
  durationYears     Int       @default(1) // Duration in years (1, 2, 3)
  createdAt         DateTime  @default(now())
  deletedAt         DateTime?
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}
